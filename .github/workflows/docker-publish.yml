name: Build and Validate Docker Image

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'screenshots/**'
      - '.gitignore'
  pull_request:
    branches:
      - main

env:
  IMAGE_NAME: prompt-studio

jobs:
  build-and-validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (validation only)
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ env.IMAGE_NAME }}:test
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Get image info
        id: image-info
        run: |
          IMAGE_SIZE=$(docker images ${{ env.IMAGE_NAME }}:test --format "{{.Size}}")
          IMAGE_ID=$(docker images ${{ env.IMAGE_NAME }}:test --format "{{.ID}}")
          echo "size=$IMAGE_SIZE" >> $GITHUB_OUTPUT
          echo "id=$IMAGE_ID" >> $GITHUB_OUTPUT

      - name: Test container startup
        run: |
          echo "Testing container can start..."
          docker run --rm -d --name test-container \
            -e SECRET_KEY=test-secret \
            -e GENESYS_CLIENT_ID=test \
            -e GENESYS_CLIENT_SECRET=test \
            -e GENESYS_ENVIRONMENT=mypurecloud.de \
            ${{ env.IMAGE_NAME }}:test &
          sleep 5
          docker stop test-container || true
          echo "âœ… Container started successfully"

      - name: Generate build report
        run: |
          echo "## ðŸ³ Docker Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Build Status: Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Name** | \`${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image Size** | \`${{ steps.image-info.outputs.size }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Image ID** | \`${{ steps.image-info.outputs.id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Date** | \`$(date -u +'%Y-%m-%d %H:%M:%S UTC')\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Manual Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This build was validated but **not pushed** to a registry." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To deploy manually on your server:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Pull the latest code:" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   cd /path/to/prompt-studio" >> $GITHUB_STEP_SUMMARY
          echo "   git pull origin main" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. Rebuild and restart the container:" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   docker compose down" >> $GITHUB_STEP_SUMMARY
          echo "   docker compose build --no-cache" >> $GITHUB_STEP_SUMMARY
          echo "   docker compose up -d" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Changes in this commit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit message:** ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
